# 前端性能优化及指标

## 时间角度：减少耗时

浏览器在页面加载过程中，会进行以下的步骤：

1. 网络请求（发起 `HTTP` 请求从服务端获取页面资源，包括 `HTML`/`CSS`/`JS`/图片资源等）
2. 浏览器解析 `HTML`/`CSS`/`JS`，渲染页面
3. 加载 `JS` 代码时会暂停页面渲染（包括解析到外部资源，会发起 `HTTP` 请求获取并加载）

在浏览器的首次加载和渲染完成之后，不代表用户就可以马上交互和操作。根据业务代码加载过程，页面还会分别进入页面开始渲染、渲染完成、用户可交互等阶段。除此之外，页面交互过程中，会根据业务逻辑进行逻辑运算、页面更新。

根据这个过程，我们可以从四个方面进行耗时优化：

### 1. 网络请求优化

网络请求优化的目标在于减少网络资源的请求和加载耗时，我们可以从两个角度来进行优化：

1. **请求链路：`DNS` 预解析、部署 `CDN` 节点、使用缓存等。**

    缓存包括 `DNS` 缓存、`CDN` 缓存、`HTTP` 缓存、后台缓存等，前端的话还可以考虑使用 `Service Worker`。除此之外，还可以考虑使用 `HTTP2`、`HTTP3` 等提升资源请求速度；对多个请求进行合并，减少通信次数；对请求进行域名拆分，提升并发请求数量等。

2. **数据大小：代码大小、图片资源等。**

    数据大小主要包括对请求资源进行合理的拆分（`CSS`、`JS` 脚本、图片/音频/视频等）和压缩，减少请求资源的体积，比如使用 `Tree-shaking`、代码分割、移除无用的依赖项等。

### 2. 首屏加载优化

首屏加载优化核心点在于两部分：

1. **将页面内容尽快地展示给用户，减少页面白屏时间。**

    > 减少白屏时间除了我们常说的首屏加载耗时优化，还可以考虑使用一些过渡的动画，让用户感知到页面正在顺利加载，从而避免用户对于白屏页面或是静止页面产生烦躁和困惑。

2. **将用户可操作的时间尽量提前，避免用户无法操作的卡顿体验。**

我们可以通过以下方式尽可能地降低首屏需要的代码量和执行耗时：

* 对页面的内容进行分片/分屏加载
* 仅加载需要的资源，通过异步或是懒加载的方式加载剩余资源
* 使用骨架屏进行预渲染
* 使用服务端渲染
* 资源预请求和预加载

### 3. 渲染过程优化

渲染过程的优化要怎么定义呢？我们可以将其理解为首屏加载完成后，用户的操作交互触发的二次渲染。

主要思路是减少用户的操作等待时间，以及通过将页面渲染帧率保持在 `60FPS` 左右，提升页面交互和渲染的流畅度。包括但不限于以下方案：

* 减少/合并 `DOM` 操作
* 使用预渲染，在页面不可见的地方提前进行渲染（比如 `Canvas` 离屏渲染）
* 通过合理使用浏览器 `GPU` 能力，提升浏览器渲染效率（比如使用 `transform` 代替 `Canvas` 缩放绘制）

### 4. 计算/逻辑运行提速

计算/逻辑运行速度优化的主要思路是“拆大为小、多路并行”，方式包括但不限于：

* 将 `JS` 大任务进行拆解，结合异步任务的管理，避免出现长时间计算导致页面卡顿
* 将耗时长且非关键逻辑的计算拆离，比如使用 `Web Worker`
* 通过将计算过程提前，减少计算等待时长，比如使用 `AOT` 技术
* 通过将计算结果缓存的方式，减少运算次数

## 空间角度优化：降低资源占用

资源占用常见的优化方式包括：

* 合理使用缓存（比如浏览器缓存、`IndexDB`），及时进行缓存清理
* 避免内存泄露，比如避免使用全局变量、及时解除引用等
* 避免复杂/异常的递归调用，导致调用栈的溢出
* 通过使用数据结构享元的方式，减少对象的创建，从而减少内存占用

## 性能优化指标

前端性能优化指标是评估网站或应用程序在用户端的加载速度、交互性和稳定性的重要标准。常见的性能指标包括以下几种：

* **First Contentful Paint (FCP)**：首次内容绘制时间。从页面开始加载到页面内容首次显示的时间，衡量用户能看到页面内容的速度。
* **Largest Contentful Paint (LCP)**：主要内容绘制时间。页面主要内容（如图片、视频或大段文字）加载完成的时间，反映页面主要内容可见的时间。
* **Time to Interactive (TTI)**：完全可交互时间。所有资源加载完毕，用户可以自由操作。
* **Total Blocking Time (TBT)**：总阻塞时间。页面加载过程中用户交互被阻止的时间，通常由 `JavaScript` 执行时间过长引起。
* **Time to First Byte (TTFB)**：首字节时间。从请求发出到收到服务器响应第一个字节的时间。
* **Interaction to Next Paint (INP)**：衡量与网页进行的每个点按、点击或键盘互动的延迟时间，并根据互动次数选择网页最差（或接近最长的互动延迟时间）作为单个代表性值，以描述网页的整体响应能力
* **Cumulative Layout Shift (CLS)**：页面元素在加载过程中发生布局位移的量，过多的位移会导致用户体验不佳。

## 参考

1. [前端性能优化-归纳篇](https://godbasin.github.io/front-end-playground/front-end-basic/performance/front-end-performance-optimization.html)
2. [以用户为中心的效果指标](https://web.dev/articles/user-centric-performance-metrics?hl=zh-cn)